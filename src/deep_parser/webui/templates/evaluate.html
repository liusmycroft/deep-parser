{% extends "base.html" %}
{% block title %}Evaluate - Deep Parser{% endblock %}
{% block content %}
<div class="row g-4">
    <div class="col-md-5">
        <div class="card">
            <div class="card-header"><h5 class="mb-0"><i class="bi bi-clipboard-data"></i> RAGAS Evaluation</h5></div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">Dataset Path</label>
                    <input type="text" id="datasetPath" class="form-control" placeholder="path/to/dataset.jsonl">
                    <small class="text-muted">JSONL format: {"question": "...", "ground_truth": ["..."]}</small>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Retrieval Parameters (optional)</label>
                    <textarea id="evalRetrievalParams" class="form-control font-monospace" rows="6" placeholder='{
  "top_k": 20,
  "routes": {"es_text": true, "vector": {"enabled": true, "backend": "milvus"}},
  "fusion": {"method": "rrf"}
}'></textarea>
                </div>
                <button class="btn btn-primary w-100" onclick="runEvaluation()" id="evalBtn">
                    <i class="bi bi-play-fill"></i> Run Evaluation
                </button>
            </div>
        </div>
    </div>
    <div class="col-md-7">
        <div class="card">
            <div class="card-header"><h5 class="mb-0"><i class="bi bi-bar-chart"></i> Evaluation Results</h5></div>
            <div class="card-body" id="evalResults">
                <div class="text-center text-muted py-5">Configure and run an evaluation to see results</div>
            </div>
        </div>
        <div class="card mt-3" id="failedCasesCard" style="display:none;">
            <div class="card-header"><h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Failed Cases</h5></div>
            <div class="card-body result-card" id="failedCases"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function runEvaluation() {
    const datasetPath = document.getElementById('datasetPath').value.trim();
    if (!datasetPath) { showAlert('Please enter a dataset path', 'warning'); return; }

    let retrievalParams = null;
    const paramsText = document.getElementById('evalRetrievalParams').value.trim();
    if (paramsText) {
        try { retrievalParams = JSON.parse(paramsText); }
        catch { showAlert('Invalid JSON in retrieval parameters', 'danger'); return; }
    }

    const btn = document.getElementById('evalBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Running...';

    const resultsDiv = document.getElementById('evalResults');
    resultsDiv.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary"></div><p class="mt-2">Running evaluation... This may take a while.</p></div>';

    try {
        const response = await fetch('/api/evaluate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ dataset_path: datasetPath, retrieval_params: retrievalParams })
        });
        const data = await response.json();

        if (!response.ok) {
            resultsDiv.innerHTML = `<div class="alert alert-danger">${data.detail || 'Evaluation failed'}</div>`;
            return;
        }

        const metrics = data.metrics || data.result?.metrics || {};
        let metricsHtml = '<h6>Metrics</h6><div class="row g-3">';
        for (const [key, value] of Object.entries(metrics)) {
            const displayValue = typeof value === 'number' ? value.toFixed(4) : value;
            metricsHtml += `
                <div class="col-md-4">
                    <div class="border rounded p-3 text-center">
                        <div class="small text-muted">${key}</div>
                        <div class="fs-4 fw-bold text-primary">${displayValue}</div>
                    </div>
                </div>`;
        }
        metricsHtml += '</div>';

        const total = data.total || data.result?.total || 0;
        const evaluated = data.evaluated || data.result?.evaluated || 0;
        metricsHtml += `<div class="mt-3 text-muted small">Total: ${total} | Evaluated: ${evaluated}</div>`;
        resultsDiv.innerHTML = metricsHtml;

        const failedCases = data.failed_cases || data.result?.failed_cases || [];
        if (failedCases.length) {
            document.getElementById('failedCasesCard').style.display = 'block';
            document.getElementById('failedCases').innerHTML = failedCases.map((fc, i) => `
                <div class="border rounded p-2 mb-2">
                    <strong class="small">Q${i + 1}:</strong> <span class="small">${fc.question || ''}</span>
                    <br><small class="text-muted">Retrieved: ${(fc.retrieved || []).length} chunks</small>
                </div>
            `).join('');
        }
    } catch (error) {
        resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-play-fill"></i> Run Evaluation';
    }
}
</script>
{% endblock %}
