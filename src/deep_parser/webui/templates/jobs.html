{% extends "base.html" %}
{% block title %}Jobs - Deep Parser{% endblock %}
{% block content %}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-list-task"></i> Job Center</h5>
        <div>
            <select id="statusFilter" class="form-select form-select-sm d-inline-block" style="width:auto" onchange="loadJobs()">
                <option value="">All Status</option>
                <option value="queued">Queued</option>
                <option value="running">Running</option>
                <option value="success">Success</option>
                <option value="failed">Failed</option>
            </select>
            <button class="btn btn-sm btn-light ms-2" onclick="loadJobs()"><i class="bi bi-arrow-clockwise"></i></button>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead><tr><th>Job ID</th><th>Type</th><th>Status</th><th>Created</th><th>Updated</th><th>Actions</th></tr></thead>
                <tbody id="jobsTableBody"><tr><td colspan="6" class="text-center text-muted">Loading...</td></tr></tbody>
            </table>
        </div>
        <nav><ul class="pagination pagination-sm justify-content-center" id="pagination"></ul></nav>
    </div>
</div>

<div class="modal fade" id="jobDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Job Detail</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body"><pre id="jobDetailContent"></pre></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;

async function loadJobs(page = 1) {
    currentPage = page;
    const status = document.getElementById('statusFilter').value;
    const params = new URLSearchParams({ skip: (page - 1) * 20, limit: 20 });
    if (status) params.append('status', status);
    try {
        const response = await fetch(`/api/jobs?${params}`);
        const data = await response.json();
        const jobs = data.jobs || data || [];
        const tbody = document.getElementById('jobsTableBody');
        if (!jobs.length) { tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No jobs found</td></tr>'; return; }
        tbody.innerHTML = jobs.map(job => `
            <tr>
                <td><code class="small">${(job.job_id || '').substring(0, 8)}...</code></td>
                <td><span class="badge bg-info">${job.job_type || ''}</span></td>
                <td>${statusBadge(job.status || '')}</td>
                <td class="small">${job.created_at ? new Date(job.created_at).toLocaleString() : ''}</td>
                <td class="small">${job.updated_at ? new Date(job.updated_at).toLocaleString() : ''}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="viewJob('${job.job_id}')"><i class="bi bi-eye"></i></button>
                    ${job.status === 'failed' ? `<button class="btn btn-sm btn-outline-warning" onclick="retryJob('${job.job_id}')"><i class="bi bi-arrow-repeat"></i></button>` : ''}
                </td>
            </tr>
        `).join('');
    } catch (error) { showAlert('Failed to load jobs: ' + error.message, 'danger'); }
}

async function viewJob(jobId) {
    try {
        const response = await fetch(`/api/jobs/${jobId}`);
        const data = await response.json();
        document.getElementById('jobDetailContent').textContent = formatJSON(data);
        new bootstrap.Modal(document.getElementById('jobDetailModal')).show();
    } catch (error) { showAlert('Failed to load job detail', 'danger'); }
}

async function retryJob(jobId) {
    try {
        const response = await fetch(`/api/jobs/${jobId}/retry`, { method: 'POST' });
        if (response.ok) { showAlert('Job retry initiated'); loadJobs(currentPage); }
        else showAlert('Retry failed', 'danger');
    } catch (error) { showAlert('Retry error: ' + error.message, 'danger'); }
}

loadJobs();
setInterval(() => loadJobs(currentPage), 10000);
</script>
{% endblock %}
